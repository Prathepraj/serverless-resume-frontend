<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Serverless Resume Generator</title>
    <link rel="stylesheet" href="style.css"> 
    <style>
        /* Basic styles for clarity */
        body { font-family: Arial, sans-serif; padding: 20px; }
        .template-buttons button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .resume-form textarea, .resume-form input { margin-bottom: 10px; width: 100%; box-sizing: border-box; }
        #previewFrame { width: 100%; height: 500px; border: 1px solid #ccc; }
    </style>
</head>
<body>
    <div id="content-container">
        
        <div id="auth-status">Checking authentication status...</div>
        
        <h1 id="main-title" style="display:none;">Choose a Resume Template</h1>

        <div class="template-buttons" style="display:none;">
            <button onclick="showPreview(1)">Template 1 (Modern)</button>
            <button onclick="showPreview(2)">Template 2 (Classic)</button>
            <button onclick="showPreview(3)">Template 3 (Professional)</button>
        </div>

        <h2 style="display:none;">Preview</h2>
        <iframe id="previewFrame" style="display:none;"></iframe>

        <h2 style="display:none;">Enter Your Details</h2>
        <form id="resumeForm" onsubmit="generatePDF(event)" style="display:none;">
            <input type="text" name="name" placeholder="Full Name" required><br>
            <input type="email" name="email" placeholder="Email" required><br>
            <input type="text" name="phone" placeholder="Phone" required><br>
            <input type="text" name="location" placeholder="Location" required><br>
            <textarea name="skills" placeholder="Skills (comma separated)" required></textarea><br>
            <textarea name="experience" placeholder="Experience HTML (use &lt;ul&gt;/&lt;li&gt; tags)"></textarea><br>
            <textarea name="education" placeholder="Education HTML (use &lt;ul&gt;/&lt;li&gt; tags)"></textarea><br>
            <textarea name="projects" placeholder="Projects HTML (optional)"></textarea><br>
            <input type="hidden" id="selectedTemplate" name="template" value="1">
            <button type="submit">Generate PDF</button>
            <button type="button" onclick="signOut()">Sign Out</button> 
            <p id="message"></p>
        </form>
    </div>

    <script src="https://unpkg.com/aws-amplify@latest/dist/aws-amplify.min.js"></script>
    
    <script>
        // ====================================================================
        // VERIFY: The global Amplify object is now expected to be defined
        // ====================================================================
        
        if (typeof Amplify === 'undefined' || typeof Amplify.configure !== 'function') {
            // If this still triggers, there is a serious network block or browser issue.
            document.getElementById('auth-status').textContent = 'Fatal Error: AWS Amplify library failed to load from CDN.';
            console.error('Amplify object not found or incomplete. Check the network connection.');
            throw new Error('AWS Amplify not initialized.');
        }

        // ====================================================================
        // AWS CONFIGURATION
        // ====================================================================
        const AWS_CONFIG = {
            Auth: {
                // User Pool ID: eu-north-1_otaYWhBnF
                userPoolId: 'eu-north-1_otaYWhBnF', 
                // App Client ID: 2ic0m094ag96r8jimm81m0oflh
                userPoolWebClientId: '2ic0m094ag96r8jimm81m0oflh', 
                region: 'eu-north-1'
            },
            API: {
                endpoints: [{
                    name: "resumeApi",
                    // API Gateway Endpoint
                    endpoint: 'https://367u3zw691.execute-api.eu-north-1.amazonaws.com/prod', 
                    region: 'eu-north-1',
                    custom_header: async () => {
                        try {
                            const session = await Amplify.Auth.currentSession();
                            return { Authorization: session.getIdToken().getJwtToken() };
                        } catch (e) {
                            console.error('No current user session:', e);
                            return {};
                        }
                    }
                }]
            }
        };

        const API_NAME = "resumeApi";
        const API_PATH = "/generate-pdf"; 
        
        // --- Core Application Functions ---

        async function checkAuthStatus() {
            const statusElement = document.getElementById('auth-status');
            try {
                // Check if user is currently authenticated
                await Amplify.Auth.currentAuthenticatedUser();
                statusElement.textContent = 'Authenticated. Ready to generate.';
                showAppUI(true);
            } catch (error) {
                // User is not authenticated, initiate the login redirect
                statusElement.textContent = 'Not authenticated. Redirecting to sign in...';
                showAppUI(false);
                Amplify.Auth.federatedSignIn(); 
            }
        }

        function showAppUI(isAuthenticated) {
            const display = isAuthenticated ? 'block' : 'none';
            document.getElementById('main-title').style.display = display;
            document.querySelector('.template-buttons').style.display = display;
            document.getElementById('previewFrame').style.display = display;
            document.getElementById('resumeForm').style.display = display;
            document.getElementById('auth-status').style.display = isAuthenticated ? 'none' : 'block';
        }

        async function generatePDF(event) {
            event.preventDefault();
            document.getElementById('message').textContent = 'Generating PDF... Please wait.';

            const formData = new FormData(document.getElementById('resumeForm'));
            const data = {};
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }

            try {
                const response = await Amplify.API.post(API_NAME, API_PATH, {
                    body: data,
                    options: {
                        responseType: 'text/html' 
                    }
                });

                const base64PDF = response; 
                
                // Convert Base64 string back into a binary PDF file (Blob)
                const binaryString = atob(base64PDF);
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                const blob = new Blob([bytes], { type: 'application/pdf' });

                // Trigger file download in the browser
                const link = document.createElement('a');
                link.href = window.URL.createObjectURL(blob);
                link.download = `${data.name.replace(/\s/g, '_')}_Resume.pdf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                document.getElementById('message').textContent = 'PDF generated and download started.';
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                document.getElementById('message').textContent = `Error generating PDF. Check the console for API error details.`;
            }
        }

        function showPreview(templateId) {
            document.getElementById('selectedTemplate').value = templateId;
            document.getElementById('message').textContent = `Template ${templateId} selected.`;
            
            // Placeholder for template preview
            document.getElementById('previewFrame').src = `template_preview_${templateId}.html`; 
        }

        async function signOut() {
            try {
                await Amplify.Auth.signOut();
                document.getElementById('auth-status').textContent = 'Signed out successfully. Redirecting...';
                showAppUI(false);
                Amplify.Auth.federatedSignIn(); 
            } catch (error) {
                console.error('Error signing out:', error);
            }
        }

        // --- Initialization ---
        
        Amplify.configure(AWS_CONFIG); 
        checkAuthStatus();

    </script>
</body>
</html>