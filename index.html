<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Serverless Resume Generator</title>
    <link rel="stylesheet" href="style.css"> 
    <style>
        /* Basic styles for clarity */
        body { font-family: Arial, sans-serif; padding: 20px; }
        .template-buttons button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .resume-form textarea, .resume-form input { margin-bottom: 10px; width: 100%; box-sizing: border-box; }
        #previewFrame { width: 100%; height: 500px; border: 1px solid #ccc; }
    </style>
</head>
<body>
    <div id="content-container">
        
        <div id="auth-status">Checking authentication status...</div>
        
        <h1 id="main-title" style="display:none;">Choose a Resume Template</h1>

        <div class="template-buttons" style="display:none;">
            <button onclick="showPreview(1)">Template 1 (Modern)</button>
            <button onclick="showPreview(2)">Template 2 (Classic)</button>
            <button onclick="showPreview(3)">Template 3 (Professional)</button>
        </div>

        <h2 style="display:none;">Preview</h2>
        <iframe id="previewFrame" style="display:none;"></iframe>

        <h2 style="display:none;">Enter Your Details</h2>
        <form id="resumeForm" onsubmit="generatePDF(event)" style="display:none;">
            <input type="text" name="name" placeholder="Full Name" required><br>
            <input type="email" name="email" placeholder="Email" required><br>
            <input type="text" name="phone" placeholder="Phone" required><br>
            <input type="text" name="location" placeholder="Location" required><br>
            <textarea name="skills" placeholder="Skills (comma separated)" required></textarea><br>
            <textarea name="experience" placeholder="Experience HTML (use <ul>/<li> tags)"></textarea><br>
            <textarea name="education" placeholder="Education HTML (use <ul>/<li> tags)"></textarea><br>
            <textarea name="projects" placeholder="Projects HTML (optional)"></textarea><br>
            <input type="hidden" id="selectedTemplate" name="template" value="1">
            <button type="submit">Generate PDF</button>
            <button type="button" onclick="signOut()">Sign Out</button> 
            <p id="message"></p>
        </form>
    </div>

    <script>
        !function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("aws_amplify",[],t):"object"==typeof exports?exports.aws_amplify=t():e.aws_amplify=t()}(this,(function(){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(r,i,function(t){return e[t]}.bind(null,i));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=123)}([function(e,t,n){"use strict";n.d(t,"c",(function(){return i})),n.d(t,"a",(function(){return o})),n.d(t,"f",(function(){return s})),n.d(t,"b",(function(){return a})),n.d(t,"d",(function(){return u})),n.d(t,"h",(function(){return c})),n.d(t,"e",(function(){return l})),n.d(t,"g",(function(){return f}));var r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(e,t)};function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}var o=function(){return(o=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};function s(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(e);i<r.length;i++)t.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(e,r[i])&&(n[r[i]]=e[r[i]])}return n}function a(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{u(r.next(e))}catch(e){o(e)}}function a(e){try{u(r.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((r=r.apply(e,t||[])).next())}))}function u(e,t){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(a){return function(u){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;o&&(o=0,a[0]&&(s=0)),s;)try{if(n=1,r&&(i=2&a[0]?r.return:a[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;switch(r=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,r=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){s.label=a[1];break}if(6===a[0]&&s.label<i[1]){s.label=i[1],i=a;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(a);break}i[2]&&s.ops.pop(),s.trys.pop();continue}a=t.call(e,s)}catch(e){a=[6,e],r=0}finally{n=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,u])}}}Object.create;function c(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function l(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,i,o=n.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(r=o.next()).done;)s.push(r.value)}catch(e){i={error:e}}finally{try{r&&!r.done&&(n=o.return)&&n.call(o)}finally{if(i)throw i.error}}return s}function f(e,t,n){if(n||2===arguments.length)for(var r,i=0,o=t.length;i<o;i++)!r&&i in t||(r||(r=Array.prototype.slice.call(t,0,i)),r[i]=t[i]);return e.concat(r||Array.prototype.slice.call(t,0,i))}}])}));
    </script>
    <script>
        // ====================================================================
        // âœ… AWS CONFIGURATION - ALL PLACEHOLDERS FILLED
        // ====================================================================
        const AWS_CONFIG = {
            Auth: {
                // User Pool ID: eu-north-1_otaYWhBnF
                userPoolId: 'eu-north-1_otaYWhBnF', 
                // App Client ID: 2ic0m094ag96r8jimm81m0oflh
                userPoolWebClientId: '2ic0m094ag96r8jimm81m0oflh', 
                region: 'eu-north-1'
            },
            API: {
                endpoints: [{
                    name: "resumeApi",
                    // API Gateway Endpoint
                    endpoint: 'https://367u3zw691.execute-api.eu-north-1.amazonaws.com/prod', 
                    region: 'eu-north-1',
                    custom_header: async () => {
                        try {
                            const session = await Amplify.Auth.currentSession();
                            return { Authorization: session.getIdToken().getJwtToken() };
                        } catch (e) {
                            console.error('No current user session:', e);
                            return {};
                        }
                    }
                }]
            }
        };

        const API_NAME = "resumeApi";
        const API_PATH = "/generate-pdf"; 
        
        // --- Core Application Functions ---

        async function checkAuthStatus() {
            const statusElement = document.getElementById('auth-status');
            try {
                // Check if user is currently authenticated
                await Amplify.Auth.currentAuthenticatedUser();
                statusElement.textContent = 'Authenticated. Ready to generate.';
                showAppUI(true);
            } catch (error) {
                // User is not authenticated, initiate the login redirect
                statusElement.textContent = 'Not authenticated. Redirecting to sign in...';
                showAppUI(false);
                Amplify.Auth.federatedSignIn(); 
            }
        }

        function showAppUI(isAuthenticated) {
            const display = isAuthenticated ? 'block' : 'none';
            document.getElementById('main-title').style.display = display;
            document.querySelector('.template-buttons').style.display = display;
            document.getElementById('previewFrame').style.display = display;
            document.getElementById('resumeForm').style.display = display;
            document.getElementById('auth-status').style.display = isAuthenticated ? 'none' : 'block';
        }

        async function generatePDF(event) {
            event.preventDefault();
            document.getElementById('message').textContent = 'Generating PDF... Please wait.';

            const formData = new FormData(document.getElementById('resumeForm'));
            const data = {};
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }

            try {
                const response = await Amplify.API.post(API_NAME, API_PATH, {
                    body: data,
                    options: {
                        // We expect the Base64 string from the Lambda, which is text.
                        responseType: 'text/html' 
                    }
                });

                const base64PDF = response; 
                
                // Convert Base64 string back into a binary PDF file (Blob)
                const binaryString = atob(base64PDF);
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++)        {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                const blob = new Blob([bytes], { type: 'application/pdf' });

                // Trigger file download in the browser
                const link = document.createElement('a');
                link.href = window.URL.createObjectURL(blob);
                link.download = `${data.name.replace(/\s/g, '_')}_Resume.pdf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                document.getElementById('message').textContent = 'PDF generated and download started.';
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                document.getElementById('message').textContent = `Error generating PDF. Check the console for API error details.`;
            }
        }

        function showPreview(templateId) {
            document.getElementById('selectedTemplate').value = templateId;
            document.getElementById('message').textContent = `Template ${templateId} selected.`;
            
            // Placeholder for template preview
            document.getElementById('previewFrame').src = `template_preview_${templateId}.html`; 
        }

        async function signOut() {
            try {
                await Amplify.Auth.signOut();
                document.getElementById('auth-status').textContent = 'Signed out successfully. Redirecting...';
                showAppUI(false);
                Amplify.Auth.federatedSignIn(); 
            } catch (error) {
                console.error('Error signing out:', error);
            }
        }

        // --- Initialization ---
        
        Amplify.configure(AWS_CONFIG); 
        checkAuthStatus();

    </script>
    </body>
</html>